name: Deploy

on:
  workflow_run:
    workflows: ["Test"]
    types:
      - completed
    branches:
      - main

jobs:
  check-workflows:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    outputs:
      ci-success: ${{ steps.check-ci.outputs.success }}
      test-success: ${{ steps.check-test.outputs.success }}
    steps:
      - name: Check CI workflow status
        id: check-ci
        uses: actions/github-script@v7
        with:
          script: |
            const { data: runs } = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'ci.yml',
              branch: context.payload.workflow_run.head_branch,
              per_page: 1
            });
            const latestRun = runs.workflow_runs[0];
            const success = latestRun && latestRun.conclusion === 'success' && latestRun.status === 'completed';
            core.setOutput('success', success);
            if (!success) {
              core.setFailed(`CI workflow did not succeed. Status: ${latestRun?.conclusion || 'not found'}`);
            }

      - name: Check Test workflow status
        id: check-test
        uses: actions/github-script@v7
        with:
          script: |
            const { data: runs } = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'test.yml',
              branch: context.payload.workflow_run.head_branch,
              per_page: 1
            });
            const latestRun = runs.workflow_runs[0];
            const success = latestRun && latestRun.conclusion === 'success' && latestRun.status === 'completed';
            core.setOutput('success', success);
            if (!success) {
              core.setFailed(`Test workflow did not succeed. Status: ${latestRun?.conclusion || 'not found'}`);
            }

  deploy:
    needs: check-workflows
    runs-on: ubuntu-latest
    if: needs.check-workflows.outputs.ci-success == 'true' && needs.check-workflows.outputs.test-success == 'true'
    env:
      PROJECT_ID: vgddrhyjttyrathqhefb
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
      - uses: ./.github/actions/setup

      - uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Link to Supabase project
        run: supabase link --project-ref $PROJECT_ID

      - name: Apply database migrations
        run: supabase db push

      - name: Deploy functions
        run: supabase functions deploy
